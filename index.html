<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinVault - Your Financial Command Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest" defer></script>
    <style>
        :root {
            --color-bg: #0f172a;
            --color-sidebar: #1e293b;
            --color-panel: #1e293b;
            --color-card-gradient-from: #334155;
            --color-card-gradient-to: #0f172a;
            --color-progress-bar: #334155;
            --color-progress-fill: #22c55e;
            --color-primary: #22c55e;
            --color-primary-hover: #16a34a;
            --color-secondary: #334155;
            --color-secondary-hover: #475569;
            --color-text: #e2e8f0;
            --color-border: #334155;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text);
        }
        .main-content {
            background-color: var(--color-panel);
        }
        .sidebar {
            background-color: var(--color-sidebar);
        }
        .card-gradient {
            background: linear-gradient(135deg, var(--color-card-gradient-from) 0%, var(--color-card-gradient-to) 100%);
        }
        .progress-bar-bg {
            background-color: var(--color-progress-bar);
        }
        .progress-bar-fill {
            background-color: var(--color-progress-fill);
        }
        .btn-primary {
            background-color: var(--color-primary);
            color: #ffffff;
        }
        .btn-primary:hover {
            background-color: var(--color-primary-hover);
        }
        .btn-secondary {
             background-color: var(--color-secondary);
             color: var(--color-text);
        }
        .btn-secondary:hover {
            background-color: var(--color-secondary-hover);
        }
        .btn-danger {
            background-color: #ef4444;
            color: #ffffff;
        }
        .btn-danger:hover {
            background-color: #dc2626;
        }
        .btn-disabled {
            background-color: #475569;
            cursor: not-allowed;
            opacity: 0.6;
        }
        /* QR Scanner Animation */
        .qr-scanner-line {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--color-primary), transparent);
            box-shadow: 0 0 10px var(--color-primary);
            animation: scan 2.5s infinite linear;
        }
        @keyframes scan {
            0% { top: 0; }
            100% { top: 100%; }
        }
        /* For custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b;
        }
        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <!-- Sidebar -->
    <aside class="sidebar w-16 md:w-64 flex-shrink-0 transition-all duration-300 ease-in-out hidden sm:flex flex-col">
        <div class="flex items-center justify-center md:justify-start px-4 h-20 border-b" style="border-color: var(--color-border);">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-8 w-8" style="color: var(--color-primary)"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
            <h1 class="text-2xl font-bold ml-2 hidden md:block">FinVault</h1>
        </div>
        <nav class="flex-1 px-2 py-4 space-y-2">
            <a href="#" class="nav-link flex items-center p-2 text-base font-normal rounded-lg bg-slate-700" data-target="dashboard">
                <i data-lucide="layout-dashboard" class="w-6 h-6"></i>
                <span class="ml-3 hidden md:block">Dashboard</span>
            </a>
            <a href="#" class="nav-link flex items-center p-2 text-base font-normal rounded-lg hover:bg-slate-700" data-target="card-control">
                <i data-lucide="credit-card" class="w-6 h-6"></i>
                <span class="ml-3 hidden md:block">Card Control</span>
            </a>
            <a href="#" class="nav-link flex items-center p-2 text-base font-normal rounded-lg hover:bg-slate-700" data-target="budgets">
                <i data-lucide="pie-chart" class="w-6 h-6"></i>
                <span class="ml-3 hidden md:block">Budgets</span>
            </a>
            <a href="#" class="nav-link flex items-center p-2 text-base font-normal rounded-lg hover:bg-slate-700" data-target="vaults">
                <i data-lucide="shield-check" class="w-6 h-6"></i>
                <span class="ml-3 hidden md:block">Vaults</span>
            </a>
             <a href="#" class="nav-link flex items-center p-2 text-base font-normal rounded-lg hover:bg-slate-700" data-target="transactions">
                <i data-lucide="list" class="w-6 h-6"></i>
                <span class="ml-3 hidden md:block">Transactions</span>
            </a>
            <a href="#" class="nav-link flex items-center p-2 text-base font-normal rounded-lg hover:bg-slate-700" data-target="settings">
                <i data-lucide="settings" class="w-6 h-6"></i>
                <span class="ml-3 hidden md:block">Settings</span>
            </a>
        </nav>
        <div class="px-2 py-4 mt-auto border-t" style="border-color: var(--color-border);">
             <a href="#" class="flex items-center p-2 text-base font-normal rounded-lg hover:bg-slate-700">
                <img src="https://i.pravatar.cc/150?u=a042581f4e29026704d" class="w-8 h-8 rounded-full" alt="User Avatar">
                <span class="ml-3 hidden md:block">John Doe</span>
            </a>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col overflow-hidden">
        <!-- Header -->
        <header class="flex items-center justify-between h-20 px-6 border-b bg-slate-800" style="border-color: var(--color-border);">
             <div class="sm:hidden">
                 <button id="mobile-menu-button" class="p-2 rounded-md">
                     <i data-lucide="menu" class="w-6 h-6"></i>
                 </button>
             </div>
             <h1 class="text-xl font-semibold" id="page-title">Dashboard</h1>
             <div class="flex items-center space-x-4 relative">
                 <button id="notifications-btn" class="p-2 rounded-full hover:bg-slate-700 relative">
                     <i data-lucide="bell" class="w-6 h-6"></i>
                     <span id="notification-dot" class="absolute top-1 right-1 block h-2 w-2 rounded-full bg-red-500"></span>
                 </button>
                 <div id="notifications-dropdown" class="absolute top-full right-0 mt-2 w-80 bg-slate-700 rounded-lg shadow-lg hidden z-10">
                    <div class="p-3 border-b border-slate-600">
                        <h4 class="font-semibold">Notifications</h4>
                    </div>
                    <div id="notification-list" class="max-h-96 overflow-y-auto">
                        <!-- Notifications will be populated by JS -->
                    </div>
                 </div>
             </div>
        </header>

        <div class="flex-1 overflow-y-auto p-6 md:p-8 space-y-8" id="main-content-area">

            <!-- Dashboard Section -->
            <section id="dashboard" class="page-section space-y-8">
                <!-- Card and AI Section -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2">
                         <!-- Premium Smart Card -->
                        <div id="smart-card-display" class="card-gradient p-6 rounded-2xl shadow-lg relative h-56 transition-all duration-300">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-sm text-slate-400">Active Account</p>
                                    <h3 id="active-account-name" class="text-xl font-semibold">Current Account</h3>
                                </div>
                                <div class="flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-10 h-10 text-white"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
                                </div>
                            </div>
                            <div class="absolute bottom-6 left-6">
                                 <p class="text-sm text-slate-400">Total Balance</p>
                                <p id="card-balance" class="text-3xl font-bold">Rs 124,530.50</p>
                                <p id="card-number" class="text-lg font-mono tracking-widest mt-2 text-slate-300">**** **** **** 8021</p>
                            </div>
                            <div id="card-frozen-overlay" class="absolute inset-0 bg-black bg-opacity-60 rounded-2xl flex items-center justify-center hidden backdrop-blur-sm">
                                <i data-lucide="snowflake" class="w-16 h-16 text-blue-300"></i>
                                <p class="text-2xl font-bold text-blue-200 ml-4">Card Frozen</p>
                            </div>
                        </div>

                         <!-- Quick Actions -->
                        <div class="mt-6 grid grid-cols-2 sm:grid-cols-4 gap-4">
                             <button id="add-money-btn" class="btn-secondary p-4 rounded-lg flex flex-col items-center justify-center space-y-2">
                                <i data-lucide="plus-circle" class="w-6 h-6"></i>
                                <span>Add Money</span>
                             </button>
                              <button class="nav-link btn-secondary p-4 rounded-lg flex flex-col items-center justify-center space-y-2" data-target="card-control">
                                <i data-lucide="shuffle" class="w-6 h-6"></i>
                                <span>Rotate Card</span>
                             </button>
                             <button id="send-money-btn" class="btn-secondary p-4 rounded-lg flex flex-col items-center justify-center space-y-2">
                                <i data-lucide="send" class="w-6 h-6"></i>
                                <span>Send</span>
                             </button>
                              <button id="qr-pay-btn" class="btn-secondary p-4 rounded-lg flex flex-col items-center justify-center space-y-2">
                                <i data-lucide="qr-code" class="w-6 h-6"></i>
                                <span>Pay with QR</span>
                             </button>
                        </div>
                    </div>

                    <!-- AI Financial Advisor -->
                    <div class="bg-slate-900/50 p-6 rounded-2xl flex flex-col">
                        <div class="flex justify-between items-center mb-4">
                             <h3 class="text-lg font-semibold">AI Financial Advisor</h3>
                             <button id="new-advice-btn" class="p-1 rounded-full hover:bg-slate-700"><i data-lucide="refresh-cw" class="w-4 h-4 text-slate-400"></i></button>
                        </div>
                        <div class="flex items-start space-x-4">
                            <div class="p-2 rounded-full" style="background-color: var(--color-primary); opacity: 0.2;">
                                <i data-lucide="brain-circuit" class="w-6 h-6" style="color: var(--color-primary);"></i>
                            </div>
                            <div id="ai-advice-content" class="flex-1 bg-slate-700 p-4 rounded-lg">
                                <!-- AI Advice populated by JS -->
                            </div>
                        </div>
                         <button id="ai-action-btn" class="btn-primary mt-auto py-2 px-4 rounded-lg w-full">Move Savings</button>
                    </div>
                </div>

                <!-- Budget Jars -->
                <div>
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-semibold">Budget Jars</h2>
                        <button class="nav-link text-sm btn-secondary py-1 px-3 rounded-md" data-target="transactions">View History</button>
                    </div>
                    <div id="dashboard-budgets" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                       <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Savings Vaults -->
                <div>
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-semibold">Savings Vaults</h2>
                        <button class="nav-link text-sm btn-secondary py-1 px-3 rounded-md" data-target="transactions">View History</button>
                    </div>
                    <div id="dashboard-vaults" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </section>

            <!-- Card Control Section -->
            <section id="card-control" class="page-section hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
                    <div>
                        <h2 class="text-2xl font-semibold mb-4">Card Control</h2>
                        <div id="smart-card-display-control" class="card-gradient p-6 rounded-2xl shadow-lg relative h-56">
                             <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-sm text-slate-400">Active Account</p>
                                    <h3 id="active-account-name-control" class="text-xl font-semibold">Current Account</h3>
                                </div>
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-10 h-10 text-white"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
                            </div>
                            <div class="absolute bottom-6 left-6">
                                <p id="card-number-control" class="text-lg font-mono tracking-widest text-slate-300">**** **** **** 8021</p>
                            </div>
                            <div id="card-frozen-overlay-control" class="absolute inset-0 bg-black bg-opacity-60 rounded-2xl flex items-center justify-center hidden backdrop-blur-sm">
                                <i data-lucide="snowflake" class="w-16 h-16 text-blue-300"></i>
                                <p class="text-2xl font-bold text-blue-200 ml-4">Card Frozen</p>
                            </div>
                        </div>
                         <div class="mt-6 flex items-center justify-between bg-slate-900/50 p-4 rounded-xl">
                            <div class="flex items-center">
                                <i data-lucide="snowflake" class="w-6 h-6 mr-3 text-blue-400"></i>
                                <span class="font-medium">Freeze Card</span>
                            </div>
                            <label for="freeze-toggle" class="inline-flex relative items-center cursor-pointer">
                                <input type="checkbox" value="" id="freeze-toggle" class="sr-only peer">
                                <div class="w-11 h-6 bg-slate-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                            </label>
                        </div>
                    </div>

                    <div class="bg-slate-900/50 p-6 rounded-2xl">
                        <h3 class="text-lg font-semibold mb-4">Rotate Active Account</h3>
                        <p class="text-sm text-slate-400 mb-6">Select which account or budget jar your physical card should use for the next transaction.</p>
                        <div class="space-y-3" id="account-selector">
                            <!-- Accounts will be populated by JS -->
                        </div>
                    </div>
                </div>
            </section>

             <!-- Budgets Section -->
            <section id="budgets" class="page-section hidden space-y-8">
                 <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-semibold">My Budgets</h2>
                        <p id="budget-count-text" class="text-sm text-slate-400 mt-1"></p>
                    </div>
                    <button id="new-budget-btn" class="btn-primary py-2 px-4 rounded-lg flex items-center">
                        <i data-lucide="plus" class="w-5 h-5 mr-2"></i>
                        New Budget
                    </button>
                 </div>
                 
                 <!-- Budget Summary -->
                <div class="bg-slate-900/50 p-6 rounded-2xl">
                    <h3 class="font-semibold text-lg mb-4">Monthly Summary</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                        <div>
                            <p class="text-sm text-slate-400">Total Budgeted</p>
                            <p id="total-budgeted" class="text-2xl font-bold font-mono"></p>
                        </div>
                        <div>
                            <p class="text-sm text-slate-400">Total Spent</p>
                            <p id="total-spent" class="text-2xl font-bold font-mono"></p>
                        </div>
                        <div>
                            <p class="text-sm text-slate-400">Remaining</p>
                            <p id="total-remaining" class="text-2xl font-bold font-mono"></p>
                        </div>
                    </div>
                </div>
                 
                 <div id="budgets-list" class="bg-slate-900/50 p-6 rounded-2xl space-y-6">
                    <!-- Populated by JS -->
                 </div>
            </section>
            
            <!-- Vaults Section -->
            <section id="vaults" class="page-section hidden">
                 <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-semibold">Savings Vaults</h2>
                        <p class="text-sm text-slate-400 mt-1">Total Saved: <span id="total-saved-vaults-page" class="font-bold text-base"></span></p>
                    </div>
                 </div>
                 <div id="savings-account-container" class="mb-8">
                    <!-- Savings Account Rendered here -->
                 </div>
                 <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold">Goal Vaults</h3>
                    <button id="new-vault-btn" class="btn-primary py-2 px-4 rounded-lg flex items-center">
                        <i data-lucide="plus" class="w-5 h-5 mr-2"></i>
                        New Vault
                    </button>
                 </div>
                 <div id="vaults-list" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                     <!-- Populated by JS -->
                 </div>
            </section>
            
            <!-- Transactions Section -->
            <section id="transactions" class="page-section hidden space-y-8">
                <div>
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-semibold">Spending History</h2>
                        <button id="export-spending-btn" class="btn-secondary py-2 px-4 rounded-lg flex items-center">
                            <i data-lucide="file-spreadsheet" class="w-5 h-5 mr-2"></i>
                            Export
                        </button>
                    </div>
                    <div class="bg-slate-900/50 rounded-2xl overflow-hidden">
                        <table class="w-full text-left">
                            <thead class="bg-slate-800">
                                <tr>
                                    <th class="p-4 font-semibold">Date</th>
                                    <th class="p-4 font-semibold">Description</th>
                                    <th class="p-4 font-semibold">Category</th>
                                    <th class="p-4 font-semibold text-right">Amount</th>
                                </tr>
                            </thead>
                            <tbody id="transaction-list">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div>
                    <h2 class="text-2xl font-semibold mb-6">Other History</h2>
                     <div class="bg-slate-900/50 p-6 rounded-2xl">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                             <button id="show-savings-history-btn" class="w-full btn-secondary p-3 rounded-lg flex items-center justify-center">
                                <i data-lucide="piggy-bank" class="w-5 h-5 mr-2"></i>
                                View Savings History
                            </button>
                            <button id="show-vault-history-btn" class="w-full btn-secondary p-3 rounded-lg flex items-center justify-center">
                                <i data-lucide="shield-check" class="w-5 h-5 mr-2"></i>
                                View Goal Vault History
                            </button>
                            <button id="show-budget-history-btn" class="w-full btn-secondary p-3 rounded-lg flex items-center justify-center">
                                <i data-lucide="pie-chart" class="w-5 h-5 mr-2"></i>
                                View Budget History
                            </button>
                        </div>
                    </div>
                </div>

                <div id="savings-history-container" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                         <h2 class="text-2xl font-semibold">Savings Account History</h2>
                         <button id="export-savings-history-btn" class="btn-secondary py-2 px-4 rounded-lg flex items-center">
                            <i data-lucide="file-spreadsheet" class="w-5 h-5 mr-2"></i>
                            Export
                        </button>
                    </div>
                     <div class="bg-slate-900/50 p-6 rounded-2xl">
                        <table class="w-full text-left">
                           <thead class="border-b" style="border-color: var(--color-border);">
                               <tr>
                                   <th class="p-3 font-semibold">Date</th>
                                   <th class="p-3 font-semibold">Action</th>
                                   <th class="p-3 font-semibold">Details</th>
                                   <th class="p-3 font-semibold text-right">Amount</th>
                               </tr>
                           </thead>
                           <tbody id="savings-history-list">
                               <!-- Populated by JS -->
                           </tbody>
                        </table>
                    </div>
                </div>

                <div id="vault-history-container" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                         <h2 class="text-2xl font-semibold">Goal Vault History</h2>
                         <button id="export-vault-history-btn" class="btn-secondary py-2 px-4 rounded-lg flex items-center">
                            <i data-lucide="file-spreadsheet" class="w-5 h-5 mr-2"></i>
                            Export
                        </button>
                    </div>
                     <div class="bg-slate-900/50 p-6 rounded-2xl">
                        <table class="w-full text-left">
                           <thead class="border-b" style="border-color: var(--color-border);">
                               <tr>
                                   <th class="p-3 font-semibold">Date</th>
                                   <th class="p-3 font-semibold">Action</th>
                                   <th class="p-3 font-semibold">Details</th>
                               </tr>
                           </thead>
                           <tbody id="vault-history-list">
                               <!-- Populated by JS -->
                           </tbody>
                        </table>
                    </div>
                </div>
                
                <div id="budget-history-container" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-semibold">Budget History</h2>
                         <button id="export-budget-history-btn" class="btn-secondary py-2 px-4 rounded-lg flex items-center">
                            <i data-lucide="file-spreadsheet" class="w-5 h-5 mr-2"></i>
                            Export
                        </button>
                    </div>
                    <div class="bg-slate-900/50 p-6 rounded-2xl">
                         <table class="w-full text-left">
                           <thead class="border-b" style="border-color: var(--color-border);">
                               <tr>
                                   <th class="p-3 font-semibold">Date</th>
                                   <th class="p-3 font-semibold">Action</th>
                                   <th class="p-3 font-semibold">Details</th>
                               </tr>
                           </thead>
                           <tbody id="budget-history-list">
                               <!-- Populated by JS -->
                           </tbody>
                        </table>
                    </div>
                </div>
            </section>
            
            <!-- Settings Section -->
            <section id="settings" class="page-section hidden space-y-8">
                <div>
                    <h2 class="text-2xl font-semibold mb-6">Settings</h2>
                    <div class="bg-slate-900/50 p-6 rounded-2xl">
                        <h3 class="text-lg font-semibold mb-4">Theme Customization</h3>
                        <p class="text-sm text-slate-400 mb-6">Choose a color scheme for your dashboard.</p>
                        <div id="theme-selector" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                            <!-- Theme options will be generated by JS -->
                        </div>
                    </div>
                </div>
                 <div>
                    <div class="bg-slate-900/50 p-6 rounded-2xl">
                        <h3 class="text-lg font-semibold mb-4">Card Security</h3>
                        <p class="text-sm text-slate-400 mb-6">Find your card's last known location.</p>
                        <button id="locate-card-btn-settings" class="btn-secondary py-2 px-4 rounded-lg flex items-center">
                            <i data-lucide="map-pin" class="w-5 h-5 mr-2"></i>
                            Locate My Card
                        </button>
                    </div>
                </div>
                <div>
                    <div class="bg-slate-900/50 p-6 rounded-2xl">
                        <h3 class="text-lg font-semibold mb-4">Simulation Controls</h3>
                        <p class="text-sm text-slate-400 mb-6">Advance time to see features like monthly returns.</p>
                        <button id="simulate-payout-btn" class="btn-primary py-2 px-4 rounded-lg">Simulate Monthly Payout</button>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Mobile Sidebar -->
    <div id="mobile-sidebar" class="fixed inset-0 bg-slate-900 z-40 transform -translate-x-full transition-transform duration-300 ease-in-out sm:hidden">
         <aside class="w-64 flex-shrink-0 flex flex-col h-full">
            <div class="flex items-center justify-between px-4 h-20 border-b border-slate-700">
                <div class="flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-8 w-8" style="color: var(--color-primary)"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
                    <h1 class="text-2xl font-bold ml-2">FinVault</h1>
                </div>
                <button id="close-mobile-menu" class="p-2">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <nav class="flex-1 px-2 py-4 space-y-2">
                <a href="#" class="nav-link flex items-center p-2 text-base font-normal rounded-lg bg-slate-700" data-target="dashboard">
                    <i data-lucide="layout-dashboard" class="w-6 h-6"></i><span class="ml-3">Dashboard</span>
                </a>
                <a href="#" class="nav-link flex items-center p-2 text-base font-normal rounded-lg hover:bg-slate-700" data-target="card-control">
                    <i data-lucide="credit-card" class="w-6 h-6"></i><span class="ml-3">Card Control</span>
                </a>
                <a href="#" class="nav-link flex items-center p-2 text-base font-normal rounded-lg hover:bg-slate-700" data-target="budgets">
                    <i data-lucide="pie-chart" class="w-6 h-6"></i><span class="ml-3">Budgets</span>
                </a>
                <a href="#" class="nav-link flex items-center p-2 text-base font-normal rounded-lg hover:bg-slate-700" data-target="vaults">
                    <i data-lucide="shield-check" class="w-6 h-6"></i><span class="ml-3">Vaults</span>
                </a>
                <a href="#" class="nav-link flex items-center p-2 text-base font-normal rounded-lg hover:bg-slate-700" data-target="transactions">
                    <i data-lucide="list" class="w-6 h-6"></i><span class="ml-3">Transactions</span>
                </a>
                 <a href="#" class="nav-link flex items-center p-2 text-base font-normal rounded-lg hover:bg-slate-700" data-target="settings">
                    <i data-lucide="settings" class="w-6 h-6"></i><span class="ml-3">Settings</span>
                </a>
            </nav>
        </aside>
    </div>

    <!-- Modals -->
    <div id="onboarding-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-slate-800 rounded-lg p-6 w-full max-w-md text-center">
             <div id="onboarding-step-1">
                <i data-lucide="gem" class="w-12 h-12 text-green-400 mx-auto mb-4"></i>
                <h3 class="text-xl font-semibold mb-2">Welcome to FinVault!</h3>
                <p class="text-slate-400 mb-6">Your all-in-one financial command center. Let's take a quick tour.</p>
                <button class="onboarding-next btn-primary py-2 px-6 rounded-lg w-full">Next</button>
             </div>
             <div id="onboarding-step-2" class="hidden">
                 <i data-lucide="pie-chart" class="w-12 h-12 text-sky-400 mx-auto mb-4"></i>
                <h3 class="text-xl font-semibold mb-2">Create Budget Jars</h3>
                <p class="text-slate-400 mb-6">Separate your money into categories like 'Food' or 'Shopping' to track your spending easily.</p>
                <div class="flex gap-4">
                    <button class="onboarding-prev btn-secondary py-2 px-6 rounded-lg w-1/2">Previous</button>
                    <button class="onboarding-next btn-primary py-2 px-6 rounded-lg w-1/2">Next</button>
                </div>
             </div>
             <div id="onboarding-step-3" class="hidden">
                <i data-lucide="credit-card" class="w-12 h-12 text-amber-400 mx-auto mb-4"></i>
                <h3 class="text-xl font-semibold mb-2">The Universal Card</h3>
                <p class="text-slate-400 mb-6">Assign any Budget Jar to your physical card to spend directly from it. You're always in control.</p>
                 <div class="flex gap-4">
                    <button class="onboarding-prev btn-secondary py-2 px-6 rounded-lg w-1/2">Previous</button>
                    <button class="onboarding-finish btn-primary py-2 px-6 rounded-lg w-1/2">Let's Get Started!</button>
                </div>
             </div>
        </div>
    </div>
    
    <div id="qr-scanner-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-slate-800 rounded-lg p-6 w-full max-w-sm text-center">
            <h3 class="text-xl font-semibold mb-4">Scan to Pay</h3>
            <div class="relative w-64 h-64 mx-auto bg-slate-900 rounded-lg overflow-hidden border-2 border-slate-600">
                <div class="absolute inset-0 bg-grid-slate-700/20"></div>
                <div class="qr-scanner-line"></div>
            </div>
            <p class="mt-4 text-slate-400 text-sm">Hold your camera up to a QR code</p>
            <button class="mt-6 btn-secondary py-2 px-6 rounded-lg" data-action="close">Cancel</button>
        </div>
    </div>

    <div id="map-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-slate-800 rounded-lg p-6 w-11/12 max-w-2xl text-center">
            <h3 class="text-xl font-semibold mb-4">Locating Your Card...</h3>
            <div class="aspect-video bg-slate-700 rounded-md flex items-center justify-center">
                <p></p>
                <i data-lucide="map" class="w-24 h-24 text-slate-500"></i>
            </div>
            <p class="mt-4 text-slate-400">Last seen: 2 minutes ago at Tariq Road, Karachi</p>
            <button id="close-map-modal" class="mt-6 btn-primary py-2 px-6 rounded-lg">Close</button>
        </div>
    </div>
    
    <div id="add-money-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-slate-800 rounded-lg p-6 w-11/12 max-w-md">
            <h3 class="text-xl font-semibold mb-4">Add Money to Current Account</h3>
            <form id="add-money-form" class="space-y-4">
                <div>
                    <label for="add-money-amount" class="block text-sm font-medium text-slate-300 mb-1">Amount</label>
                    <input type="number" id="add-money-amount" name="add-money-amount" class="w-full bg-slate-700 border-slate-600 rounded-md p-2" placeholder="e.g., 10000" required>
                </div>
                <div>
                    <label for="add-money-source" class="block text-sm font-medium text-slate-300 mb-1">Source</label>
                    <select id="add-money-source" name="add-money-source" class="w-full bg-slate-700 border-slate-600 rounded-md p-2">
                        <option>Linked Bank Account (**** 1234)</option>
                        <option>Debit Card (**** 5678)</option>
                    </select>
                </div>
                <div class="flex justify-end gap-4 pt-4">
                    <button type="button" class="btn-secondary py-2 px-4 rounded-lg" data-action="close">Cancel</button>
                    <button type="submit" class="btn-primary py-2 px-4 rounded-lg">Add Money</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="send-money-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-slate-800 rounded-lg p-6 w-11/12 max-w-md">
            <h3 class="text-xl font-semibold mb-4">Send Money</h3>
            <form id="send-money-form" class="space-y-4">
                 <div>
                    <label for="send-money-recipient" class="block text-sm font-medium text-slate-300 mb-1">Recipient Account/IBAN</label>
                    <input type="text" id="send-money-recipient" name="send-money-recipient" class="w-full bg-slate-700 border-slate-600 rounded-md p-2" placeholder="e.g., PK36SCBL0000001123456789" required>
                </div>
                <div>
                    <label for="send-money-amount" class="block text-sm font-medium text-slate-300 mb-1">Amount</label>
                    <input type="number" id="send-money-amount" name="send-money-amount" class="w-full bg-slate-700 border-slate-600 rounded-md p-2" placeholder="e.g., 2500" required>
                </div>
                <div>
                    <label for="send-money-service" class="block text-sm font-medium text-slate-300 mb-1">Service</label>
                    <select id="send-money-service" name="send-money-service" class="w-full bg-slate-700 border-slate-600 rounded-md p-2">
                        <option>Bank Transfer</option>
                        <option>JazzCash</option>
                        <option>Easypaisa</option>
                    </select>
                </div>
                <div class="flex justify-end gap-4 pt-4">
                    <button type="button" class="btn-secondary py-2 px-4 rounded-lg" data-action="close">Cancel</button>
                    <button type="submit" class="btn-primary py-2 px-4 rounded-lg">Send Money</button>
                </div>
            </form>
        </div>
    </div>

    <div id="new-vault-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-slate-800 rounded-lg p-6 w-11/12 max-w-md">
            <h3 class="text-xl font-semibold mb-4">Create New Vault</h3>
            <form id="new-vault-form" class="space-y-4">
                <div>
                    <label for="vault-name" class="block text-sm font-medium text-slate-300 mb-1">Vault Name</label>
                    <input type="text" id="vault-name" name="vault-name" class="w-full bg-slate-700 border-slate-600 rounded-md p-2 focus:ring-2 focus:ring-green-500" placeholder="e.g., Vacation Trip" required>
                </div>
                <div>
                    <label for="vault-target" class="block text-sm font-medium text-slate-300 mb-1">Target Amount</label>
                    <input type="number" id="vault-target" name="vault-target" class="w-full bg-slate-700 border-slate-600 rounded-md p-2 focus:ring-2 focus:ring-green-500" placeholder="e.g., 200000" required>
                </div>
                <div class="flex justify-end gap-4 pt-4">
                    <button type="button" class="btn-secondary py-2 px-4 rounded-lg" data-action="close">Cancel</button>
                    <button type="submit" class="btn-primary py-2 px-4 rounded-lg">Create Vault</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="new-budget-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-slate-800 rounded-lg p-6 w-11/12 max-w-md">
            <h3 class="text-xl font-semibold mb-4">Create New Budget</h3>
            <form id="new-budget-form" class="space-y-4">
                <div>
                    <label for="budget-name" class="block text-sm font-medium text-slate-300 mb-1">Budget Name</label>
                    <input type="text" id="budget-name" name="budget-name" class="w-full bg-slate-700 border-slate-600 rounded-md p-2 focus:ring-2 focus:ring-green-500" placeholder="e.g., Groceries" required>
                </div>
                <div>
                    <label for="budget-limit" class="block text-sm font-medium text-slate-300 mb-1">Monthly Limit</label>
                    <input type="number" id="budget-limit" name="budget-limit" class="w-full bg-slate-700 border-slate-600 rounded-md p-2 focus:ring-2 focus:ring-green-500" placeholder="e.g., 25000" required>
                </div>
                <div class="flex justify-end gap-4 pt-4">
                    <button type="button" class="btn-secondary py-2 px-4 rounded-lg" data-action="close">Cancel</button>
                    <button type="submit" class="btn-primary py-2 px-4 rounded-lg">Create Budget</button>
                </div>
            </form>
        </div>
    </div>

    <div id="update-budget-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-slate-800 rounded-lg p-6 w-11/12 max-w-md">
            <h3 class="text-xl font-semibold mb-4">Update Budget</h3>
            <form id="update-budget-form" class="space-y-4">
                <input type="hidden" id="update-budget-id" name="update-budget-id">
                <div>
                    <label for="update-budget-name" class="block text-sm font-medium text-slate-300 mb-1">Budget Name</label>
                    <input type="text" id="update-budget-name" name="update-budget-name" class="w-full bg-slate-700 border-slate-600 rounded-md p-2 focus:ring-2 focus:ring-green-500" required>
                </div>
                <div>
                    <label for="update-budget-limit" class="block text-sm font-medium text-slate-300 mb-1">Monthly Limit</label>
                    <input type="number" id="update-budget-limit" name="update-budget-limit" class="w-full bg-slate-700 border-slate-600 rounded-md p-2 focus:ring-2 focus:ring-green-500" required>
                </div>
                <div class="flex justify-end gap-4 pt-4">
                    <button type="button" class="btn-secondary py-2 px-4 rounded-lg" data-action="close">Cancel</button>
                    <button type="submit" class="btn-primary py-2 px-4 rounded-lg">Update Budget</button>
                </div>
            </form>
        </div>
    </div>

    <div id="vault-action-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-slate-800 rounded-lg p-6 w-11/12 max-w-md">
            <h3 id="vault-action-title" class="text-xl font-semibold mb-4">Vault Action</h3>
            <form id="vault-action-form" class="space-y-4">
                <input type="hidden" id="vault-action-id" name="vault-action-id">
                <input type="hidden" id="vault-action-type" name="vault-action-type">
                <div>
                    <label for="vault-action-amount" class="block text-sm font-medium text-slate-300 mb-1">Amount</label>
                    <input type="number" id="vault-action-amount" name="vault-action-amount" class="w-full bg-slate-700 border-slate-600 rounded-md p-2 focus:ring-2 focus:ring-green-500" placeholder="e.g., 5000" required>
                </div>
                <div class="flex justify-end gap-4 pt-4">
                    <button type="button" class="btn-secondary py-2 px-4 rounded-lg" data-action="close">Cancel</button>
                    <button type="submit" id="vault-action-submit" class="btn-primary py-2 px-4 rounded-lg">Confirm</button>
                </div>
            </form>
        </div>
    </div>

    <div id="confirm-delete-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-slate-800 rounded-lg p-6 w-11/12 max-w-md text-center">
            <i data-lucide="alert-triangle" class="w-12 h-12 text-red-500 mx-auto mb-4"></i>
            <h3 id="confirm-delete-title" class="text-xl font-semibold mb-2">Are you sure?</h3>
            <p id="confirm-delete-message" class="text-slate-400 mb-6">This action cannot be undone.</p>
            <div class="flex justify-center gap-4">
                <button type="button" class="btn-secondary py-2 px-6 rounded-lg" data-action="close">Cancel</button>
                <button type="button" id="confirm-delete-btn" class="btn-danger py-2 px-6 rounded-lg">Delete</button>
            </div>
        </div>
    </div>

    <div id="toast-notification" class="fixed bottom-8 right-8 bg-green-600 text-white py-3 px-6 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 ease-in-out z-50">
        <p id="toast-message"></p>
    </div>


<script>
(function() { // IIFE Start
    "use strict";

    // --- MOCK DATA & CONFIG ---
    const MAX_BUDGETS = 5;
    const MAX_CARD_ASSIGNMENTS = 3;

    let accounts = [
        { id: 'current', name: 'Current Account', balance: 124530.50, type: 'account' },
    ];
    
    let budgetsData = [
        { id: 'food', name: 'Food', spent: 12340, limit: 20000, icon: 'utensils-crossed', color: 'rose', isCardAssigned: true },
        { id: 'shopping', name: 'Shopping', spent: 7810, limit: 15000, icon: 'shopping-cart', color: 'sky', isCardAssigned: true },
        { id: 'transport', name: 'Transport', spent: 9500, limit: 10000, icon: 'car', color: 'amber', isCardAssigned: true },
        { id: 'entertainment', name: 'Entertainment', spent: 2500, limit: 5000, icon: 'film', color: 'violet', isCardAssigned: false },
    ];

    let vaultsData = [
        { id: 'savings-account', name: 'Savings Account', current: 500000, target: null, icon: 'piggy-bank', color: 'green', isSavingsAccount: true, returnRate: 0.10 },
        { id: 'emergency', name: 'Emergency Fund', current: 85000, target: 100000, icon: 'shield', color: 'indigo' },
        { id: 'laptop', name: 'New Laptop', current: 60000, target: 150000, icon: 'briefcase', color: 'cyan' },
        { id: 'vacation', name: 'Vacation Trip', current: 130000, target: 200000, icon: 'plane', color: 'fuchsia' },
    ];
    
    let savingsAccountHistoryData = [
        { date: 'Aug 1, 2025', action: 'Deposit', details: 'Initial Deposit', amount: 500000 },
    ];

    let vaultHistoryData = [
        { date: 'Aug 20, 2025', action: 'Created', details: 'Emergency Fund (Target: Rs 100,000)'},
        { date: 'Aug 25, 2025', action: 'Created', details: 'New Laptop (Target: Rs 150,000)'},
        { date: 'Sep 1, 2025', action: 'Closed', details: 'Old Phone Vault (Achieved)'},
    ];
    
    let budgetHistoryData = [
        { date: 'Aug 1, 2025', action: 'Created', details: 'Food Budget (Limit: Rs 20,000)'},
        { date: 'Aug 15, 2025', action: 'Updated', details: 'Transport Budget (Limit: Rs 10,000 -> Rs 12,000)'},
        { date: 'Sep 1, 2025', action: 'Archived', details: 'August Shopping Budget'},
    ];
    
    let transactionsData = [
        { date: 'Sep 1, 2025', desc: 'Netflix Subscription', cat: 'Entertainment', amount: -1200.00 },
        { date: 'Sep 1, 2025', desc: 'Foodpanda Order', cat: 'Food', amount: -2550.00 },
        { date: 'Aug 31, 2025', desc: 'Daraz Online Shopping', cat: 'Shopping', amount: -5400.00 },
        { date: 'Aug 30, 2025', desc: 'Salary Deposit', cat: 'Income', amount: 95000.00 },
        { date: 'Aug 29, 2025', desc: 'Careem Ride', cat: 'Transport', amount: -850.00 },
    ];

    const notificationsData = [
        { text: "Your 'Food' budget is 85% used.", time: "1h ago", icon: "pie-chart" },
        { text: "Monthly interest has been paid to your Savings Account.", time: "3h ago", icon: "piggy-bank" },
        { text: "Transaction of Rs 2,550 to Foodpanda was successful.", time: "1d ago", icon: "receipt" }
    ];
    
    let currentAdviceIndex = 0;
    let activeAccountId = 'current';
    let isCardFrozen = false;
    let itemToDelete = { id: null, type: null };

    // --- DOM ELEMENTS ---
    const pageSections = document.querySelectorAll('.page-section');
    const navLinks = document.querySelectorAll('.nav-link');
    const pageTitle = document.getElementById('page-title');
    const mobileSidebar = document.getElementById('mobile-sidebar');
    const mobileMenuButton = document.getElementById('mobile-menu-button');
    const closeMobileMenuButton = document.getElementById('close-mobile-menu');

    // Card display elements
    const cardDisplay = document.getElementById('smart-card-display');
    const activeAccountName = document.getElementById('active-account-name');
    const cardBalance = document.getElementById('card-balance');
    const cardFrozenOverlay = document.getElementById('card-frozen-overlay');

    // Card control elements
    const cardDisplayControl = document.getElementById('smart-card-display-control');
    const activeAccountNameControl = document.getElementById('active-account-name-control');
    const cardFrozenOverlayControl = document.getElementById('card-frozen-overlay-control');
    const freezeToggle = document.getElementById('freeze-toggle');
    const accountSelector = document.getElementById('account-selector');
    
    // Modal elements
    const onboardingModal = document.getElementById('onboarding-modal');
    const qrScannerModal = document.getElementById('qr-scanner-modal');
    const mapModal = document.getElementById('map-modal');
    const addMoneyModal = document.getElementById('add-money-modal');
    const sendMoneyModal = document.getElementById('send-money-modal');
    const locateCardBtnSettings = document.getElementById('locate-card-btn-settings');
    const closeMapModalBtn = document.getElementById('close-map-modal');
    const newVaultModal = document.getElementById('new-vault-modal');
    const newBudgetModal = document.getElementById('new-budget-modal');
    const updateBudgetModal = document.getElementById('update-budget-modal');
    const vaultActionModal = document.getElementById('vault-action-modal');
    const confirmDeleteModal = document.getElementById('confirm-delete-modal');

    // Modal Forms & Buttons
    const addMoneyForm = document.getElementById('add-money-form');
    const sendMoneyForm = document.getElementById('send-money-form');
    const newVaultForm = document.getElementById('new-vault-form');
    const newBudgetForm = document.getElementById('new-budget-form');
    const updateBudgetForm = document.getElementById('update-budget-form');
    const vaultActionForm = document.getElementById('vault-action-form');
    const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
    
    // Transactions & Export
    const transactionList = document.getElementById('transaction-list');
    const exportSpendingBtn = document.getElementById('export-spending-btn');
    const exportSavingsHistoryBtn = document.getElementById('export-savings-history-btn');
    const exportVaultHistoryBtn = document.getElementById('export-vault-history-btn');
    const exportBudgetHistoryBtn = document.getElementById('export-budget-history-btn');
    
    // Theme elements
    const themeSelector = document.getElementById('theme-selector');
    
    // History elements
    const showSavingsHistoryBtn = document.getElementById('show-savings-history-btn');
    const showVaultHistoryBtn = document.getElementById('show-vault-history-btn');
    const showBudgetHistoryBtn = document.getElementById('show-budget-history-btn');
    const savingsHistoryContainer = document.getElementById('savings-history-container');
    const vaultHistoryContainer = document.getElementById('vault-history-container');
    const budgetHistoryContainer = document.getElementById('budget-history-container');

    // Simulation
    const simulatePayoutBtn = document.getElementById('simulate-payout-btn');
    
    // Toast Notification
    const toastNotification = document.getElementById('toast-notification');
    const toastMessage = document.getElementById('toast-message');

    // AI Advisor elements
    const aiAdviceContent = document.getElementById('ai-advice-content');
    const aiActionButton = document.getElementById('ai-action-btn');

    // Notifications
    const notificationsBtn = document.getElementById('notifications-btn');
    const notificationsDropdown = document.getElementById('notifications-dropdown');
    const notificationList = document.getElementById('notification-list');

    // --- THEME CUSTOMIZATION ---
    const themes = {
        'Slate': {
            '--color-bg': '#0f172a', '--color-sidebar': '#1e293b', '--color-panel': '#1e293b',
            '--color-card-gradient-from': '#334155', '--color-card-gradient-to': '#0f172a',
            '--color-primary': '#22c55e', '--color-primary-hover': '#16a34a',
            '--color-progress-fill': '#22c55e',
        },
        'Ocean': {
            '--color-bg': '#0B2545', '--color-sidebar': '#13315C', '--color-panel': '#13315C',
            '--color-card-gradient-from': '#1E4976', '--color-card-gradient-to': '#0B2545',
            '--color-primary': '#37BEEB', '--color-primary-hover': '#24A8D6',
            '--color-progress-fill': '#37BEEB',
        },
        'Forest': {
            '--color-bg': '#1a2e29', '--color-sidebar': '#243b35', '--color-panel': '#243b35',
            '--color-card-gradient-from': '#2f5d51', '--color-card-gradient-to': '#1a2e29',
            '--color-primary': '#34d399', '--color-primary-hover': '#10b981',
            '--color-progress-fill': '#34d399',
        },
        'Sunset': {
            '--color-bg': '#4c1d3d', '--color-sidebar': '#6b2a57', '--color-panel': '#6b2a57',
            '--color-card-gradient-from': '#9d3d7a', '--color-card-gradient-to': '#4c1d3d',
            '--color-primary': '#f472b6', '--color-primary-hover': '#ec4899',
            '--color-progress-fill': '#f472b6',
        }
    };

    // --- DATA MANIPULATION (BUSINESS LOGIC) ---

    function createBudget(name, limit) {
        if (budgetsData.length >= MAX_BUDGETS || !name || limit <= 0) return false;
        
        const newBudgetId = name.toLowerCase().replace(/\s+/g, '-') + Date.now();
        budgetsData.unshift({
            id: newBudgetId, name: name, spent: 0, limit: limit, icon: 'receipt', color: 'purple', isCardAssigned: false
        });
        budgetHistoryData.unshift({
            date: getCurrentDate(), action: 'Created', details: `${name} Budget (Limit: Rs ${limit.toLocaleString('en-IN')})`
        });
        return true;
    }

    function updateBudget(id, newName, newLimit) {
        const budget = budgetsData.find(b => b.id === id);
        if(!budget || !newName || newLimit <= 0) return false;

        const oldLimit = budget.limit;
        budget.name = newName;
        budget.limit = newLimit;
        
        budgetHistoryData.unshift({
            date: getCurrentDate(), action: 'Updated', details: `${newName} (Limit: Rs ${oldLimit.toLocaleString('en-IN')} -> Rs ${newLimit.toLocaleString('en-IN')})`
        });
        return true;
    }

    function deleteBudget(id) {
        const budgetIndex = budgetsData.findIndex(b => b.id === id);
        if (budgetIndex === -1) return;
        
        budgetsData.splice(budgetIndex, 1);
        budgetHistoryData.unshift({
            date: getCurrentDate(), action: 'Deleted', details: `Budget item removed.`
        });
    }

    function createVault(name, target) {
        if (!name || target <= 0) return false;

        vaultsData.push({
            id: name.toLowerCase().replace(/\s+/g, '-') + Date.now(),
            name: name, current: 0, target: target, icon: 'package-plus', color: 'teal'
        });
        vaultHistoryData.unshift({
            date: getCurrentDate(), action: 'Created', details: `${name} (Target: Rs ${target.toLocaleString('en-IN')})`
        });
        return true;
    }

    function deleteVault(id) {
        const vaultIndex = vaultsData.findIndex(v => v.id === id);
        if (vaultIndex === -1) return;
        
        const vault = vaultsData[vaultIndex];
        if (vault.current > 0) {
            accounts.find(a => a.id === 'current').balance += vault.current;
        }
        
        vaultsData.splice(vaultIndex, 1);
        vaultHistoryData.unshift({
            date: getCurrentDate(), action: 'Deleted', details: `Vault "${vault.name}" removed. Rs ${vault.current.toLocaleString('en-IN')} returned.`
        });
    }

    function handleVaultTransaction(vaultId, actionType, amount) {
        const vault = vaultsData.find(v => v.id === vaultId);
        const currentAccount = accounts.find(a => a.id === 'current');

        if (!vault || !currentAccount || !amount || amount <= 0) return false;

        if (actionType === 'deposit') {
            if (currentAccount.balance >= amount) {
                vault.current += amount;
                currentAccount.balance -= amount;
                 if (vault.isSavingsAccount) {
                    savingsAccountHistoryData.unshift({ date: getCurrentDate(), action: 'Deposit', details: `Manual Deposit`, amount: amount });
                } else {
                    vaultHistoryData.unshift({ date: getCurrentDate(), action: 'Deposited', details: `Rs ${amount.toLocaleString('en-IN')} to ${vault.name}` });
                }
                return true;
            } else {
                showToast('Insufficient funds in Current Account.');
                return false;
            }
        } else if (actionType === 'withdraw') {
            if (vault.current >= amount) {
                vault.current -= amount;
                currentAccount.balance += amount;
                if (vault.isSavingsAccount) {
                    savingsAccountHistoryData.unshift({ date: getCurrentDate(), action: 'Withdrawal', details: `Manual Withdrawal`, amount: -amount });
                } else {
                    vaultHistoryData.unshift({ date: getCurrentDate(), action: 'Withdrew', details: `Rs ${amount.toLocaleString('en-IN')} from ${vault.name}` });
                }
                return true;
            } else {
                showToast('Insufficient funds in vault.');
                return false;
            }
        }
    }

    function calculateAndApplyMonthlyReturns() {
        const savingsAccount = vaultsData.find(v => v.isSavingsAccount);
        if (savingsAccount) {
            const monthlyReturnRate = savingsAccount.returnRate / 12;
            const profit = savingsAccount.current * monthlyReturnRate;
            savingsAccount.current += profit;

            savingsAccountHistoryData.unshift({
                date: getCurrentDate(), action: 'Profit Payout', details: `Monthly interest credited`, amount: profit
            });
            
            showToast(`Profit of Rs ${profit.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} has been added.`);
        }
    }

    function getSmartAIAdvice() {
        // Check for high budget usage
        for (const budget of budgetsData) {
            const usage = budget.spent / budget.limit;
            if (usage > 0.9) {
                return { text: `Warning: Your '${budget.name}' budget is ${Math.round(usage * 100)}% used. Be mindful of your spending.`, action: 'none' };
            }
        }

        // Check for near-complete vaults
        for (const vault of vaultsData) {
            if (!vault.isSavingsAccount && vault.target) {
                const progress = vault.current / vault.target;
                if (progress > 0.8 && progress < 1) {
                    return { text: `Congratulations! You're ${Math.round(progress * 100)}% of the way to your '${vault.name}' goal. Keep it up!`, action: 'none' };
                }
            }
        }
        
        // Suggest assigning a card
        const assignedCount = budgetsData.filter(b => b.isCardAssigned).length;
        const unassignedBudgets = budgetsData.filter(b => !b.isCardAssigned);
        if (assignedCount < MAX_CARD_ASSIGNMENTS && unassignedBudgets.length > 0) {
            return { text: `You have a free card slot. Try assigning your '${unassignedBudgets[0].name}' budget to your card for easier spending.`, action: 'none' };
        }

        // Fallback to a random generic tip
        const genericTips = aiAdvicePool.filter(a => a.action === 'none');
        return genericTips[Math.floor(Math.random() * genericTips.length)];
    }

    // --- UI RENDERING & HELPERS ---
    
    function getCurrentDate() {
        return new Date().toLocaleString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }
    
    function showToast(message) {
        toastMessage.textContent = message;
        toastNotification.classList.remove('translate-y-20', 'opacity-0');
        setTimeout(() => {
            toastNotification.classList.add('translate-y-20', 'opacity-0');
        }, 3000); // Hide after 3 seconds
    }

    function exportToCsv(filename, headers, data) {
        const rows = data.map(item =>
            headers.map(header => {
                let val = item[header.toLowerCase()];
                if (typeof val === 'number') val = val.toLocaleString('en-IN');
                return `"${(val || '').toString().replace(/"/g, '""')}"`;
            }).join(',')
        );
        const csvContent = "data:text/csv;charset=utf-8," + headers.join(',') + "\n" + rows.join("\n");
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", filename);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function showPage(targetId) {
        pageSections.forEach(section => section.classList.toggle('hidden', section.id !== targetId));
        const targetLink = document.querySelector(`.nav-link[data-target="${targetId}"]`);
        if (targetLink) pageTitle.textContent = targetLink.querySelector('span').textContent;
        navLinks.forEach(link => {
            link.classList.remove('bg-slate-700');
            if (link.dataset.target === targetId) link.classList.add('bg-slate-700');
        });
        mobileSidebar.classList.add('-translate-x-full');
    }
    
    function generateThemeSelector() {
        const currentTheme = loadTheme();
        if (!themeSelector) return;
        themeSelector.innerHTML = '';
        for (const themeName in themes) {
            const theme = themes[themeName];
            const isActive = themeName === currentTheme;
            const button = document.createElement('button');
            button.className = `theme-btn p-4 rounded-lg border-2 ${isActive ? 'border-white' : 'border-transparent'} transition-all`;
            button.dataset.theme = themeName;
            button.innerHTML = `
                <div class="h-12 w-full rounded-md mb-2" style="background: linear-gradient(135deg, ${theme['--color-card-gradient-from']}, ${theme['--color-card-gradient-to']})"></div>
                <p class="font-medium">${themeName}</p>
            `;
            themeSelector.appendChild(button);
        }
    }
    
    function applyTheme(themeName) {
        const theme = themes[themeName];
        if (!theme) return;
        for (const [key, value] of Object.entries(theme)) {
            document.documentElement.style.setProperty(key, value);
        }
    }

    function saveTheme(themeName) {
        localStorage.setItem('finvaultTheme', themeName);
    }

    function loadTheme() {
        const savedTheme = localStorage.getItem('finvaultTheme') || 'Slate';
        applyTheme(savedTheme);
        return savedTheme;
    }

    function updateUI() {
        try {
            rebuildCardAccounts();
            
            const activeAccount = accounts.find(acc => acc.id === activeAccountId);
            if (!activeAccount) activeAccountId = 'current';
            
            const currentActiveAccount = accounts.find(acc => acc.id === activeAccountId);
            if(activeAccountName) activeAccountName.textContent = currentActiveAccount.name;
            if(activeAccountNameControl) activeAccountNameControl.textContent = currentActiveAccount.name;
            
            if(cardBalance) cardBalance.textContent = `Rs ${accounts.find(a => a.id === 'current').balance.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            if(cardFrozenOverlay) cardFrozenOverlay.classList.toggle('hidden', !isCardFrozen);
            if(cardFrozenOverlayControl) cardFrozenOverlayControl.classList.toggle('hidden', !isCardFrozen);
            if(freezeToggle) freezeToggle.checked = isCardFrozen;
            [cardDisplay, cardDisplayControl].forEach(el => { if(el) el.classList.toggle('grayscale', isCardFrozen) });

            populateAccountSelector();
            renderDashboardItems();
            renderBudgets();
            renderVaults();
            renderAllHistory();
            populateTransactions();
            renderNotifications();
            displayAIAdvice();

            lucide.createIcons();
        } catch (error) {
            console.error("Failed to update UI:", error);
        }
    }

    function rebuildCardAccounts() {
        const assignedBudgets = budgetsData.filter(b => b.isCardAssigned);
        const currentAccount = { id: 'current', name: 'Current Account', balance: accounts.find(a=>a.id==='current').balance, type: 'account' };
        
        accounts = [currentAccount, ...assignedBudgets.map(b => ({
            id: b.id, name: `${b.name} Jar`, balance: b.limit - b.spent, type: 'budget'
        }))];
    }

    function populateAccountSelector() {
        if (!accountSelector) return;
        accountSelector.innerHTML = '';
        accounts.forEach(account => {
            const isChecked = account.id === activeAccountId;
            accountSelector.insertAdjacentHTML('beforeend', `
                <label for="acc-${account.id}" class="flex items-center p-4 rounded-lg cursor-pointer transition-colors ${isChecked ? 'bg-green-500/20 border-green-500' : 'bg-slate-800 border-transparent'} border hover:bg-slate-700">
                    <input type="radio" id="acc-${account.id}" name="activeAccount" value="${account.id}" class="hidden" ${isChecked ? 'checked' : ''}>
                    <div class="flex-1">
                        <p class="font-medium">${account.name}</p>
                        <p class="text-sm text-slate-400">Available: Rs ${account.balance.toLocaleString('en-IN')}</p>
                    </div>
                    ${isChecked ? '<i data-lucide="check-circle-2" class="w-6 h-6 text-green-500"></i>' : ''}
                </label>
            `);
        });
    }
    
    function populateTransactions() {
        if (!transactionList) return;
        transactionList.innerHTML = '';
        transactionsData.forEach(tx => {
            const amountClass = tx.amount > 0 ? 'text-green-400' : 'text-slate-300';
            const sign = tx.amount > 0 ? '+' : '';
            transactionList.insertAdjacentHTML('beforeend', `
                <tr class="border-b last:border-b-0" style="border-color: var(--color-border);">
                    <td class="p-4">${tx.date}</td>
                    <td class="p-4 font-medium">${tx.desc}</td>
                    <td class="p-4 text-slate-400">${tx.cat}</td>
                    <td class="p-4 text-right font-mono ${amountClass}">${sign}Rs ${Math.abs(tx.amount).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                </tr>
            `);
        });
    }
    
    function renderDashboardItems() {
        const dashboardBudgets = document.getElementById('dashboard-budgets');
        const dashboardVaults = document.getElementById('dashboard-vaults');
        if (!dashboardBudgets || !dashboardVaults) return;
        
        dashboardBudgets.innerHTML = '';
        budgetsData.slice(0, 3).forEach(budget => {
            const percentage = budget.limit > 0 ? Math.round((budget.spent / budget.limit) * 100) : 0;
            const progressBarColor = percentage > 90 ? 'bg-red-500' : 'progress-bar-fill';
            const percentageColor = percentage > 90 ? '#f87171' : 'var(--color-primary)';
            dashboardBudgets.insertAdjacentHTML('beforeend', `
                 <div class="bg-slate-900/50 p-4 rounded-xl flex flex-col h-full">
                    <div class="flex items-center space-x-3">
                        <div class="p-2 bg-${budget.color}-500/20 rounded-lg"><i data-lucide="${budget.icon}" class="w-5 h-5 text-${budget.color}-400"></i></div>
                        <span class="font-medium">${budget.name}</span>
                    </div>
                    <div class="text-center my-auto py-2">
                        <p class="text-2xl font-bold font-mono">Rs ${budget.spent.toLocaleString('en-IN')}</p>
                        <p class="font-medium text-sm mt-1" style="color: ${percentageColor}">${percentage}% Used</p>
                    </div>
                    <div class="w-full progress-bar-bg rounded-full h-2.5 mt-auto">
                        <div class="${progressBarColor} h-2.5 rounded-full" style="width: ${percentage}%"></div>
                    </div>
                </div>
            `);
        });

        dashboardVaults.innerHTML = '';
        let totalSaved = 0;
        vaultsData.forEach(vault => {
            totalSaved += vault.current;
            const isSavings = vault.isSavingsAccount;
            const percentage = !isSavings && vault.target > 0 ? Math.round((vault.current / vault.target) * 100) : 0;
            dashboardVaults.insertAdjacentHTML('beforeend', `
                 <div class="bg-slate-900/50 p-4 rounded-xl flex flex-col h-full ${isSavings ? 'border border-green-500/30' : ''}">
                    <div class="flex items-center space-x-3">
                         <div class="p-2 bg-${vault.color}-500/20 rounded-lg"><i data-lucide="${vault.icon}" class="w-5 h-5 text-${vault.color}-400"></i></div>
                        <span class="font-medium">${vault.name}</span>
                    </div>
                    <div class="text-center my-auto py-2">
                        <p class="text-2xl font-bold font-mono">Rs ${isSavings ? Math.floor(vault.current).toLocaleString('en-IN') : vault.current.toLocaleString('en-IN')}</p>
                        <p class="font-medium text-sm mt-1" style="color: var(--color-primary)">${isSavings ? `${(vault.returnRate * 100).toFixed(0)}% APR` : `${percentage}% Complete`}</p>
                    </div>
                    ${!isSavings ? `
                    <div class="w-full progress-bar-bg rounded-full h-2.5 mt-auto">
                        <div class="progress-bar-fill h-2.5 rounded-full" style="width: ${percentage}%"></div>
                    </div>` : '<div class="h-2.5 mt-auto"></div>' }
                </div>
            `);
        });
        
        const totalSavedVaultsPage = document.getElementById('total-saved-vaults-page');
        if(totalSavedVaultsPage) totalSavedVaultsPage.textContent = `Rs ${totalSaved.toLocaleString('en-IN')}`;
    }
    
    function renderBudgetTotals() {
        const totalBudgetedEl = document.getElementById('total-budgeted');
        if (!totalBudgetedEl) return;
        
        const totalBudgeted = budgetsData.reduce((sum, b) => sum + b.limit, 0);
        const totalSpent = budgetsData.reduce((sum, b) => sum + b.spent, 0);
        const totalRemaining = totalBudgeted - totalSpent;
        
        totalBudgetedEl.textContent = `Rs ${totalBudgeted.toLocaleString('en-IN')}`;
        document.getElementById('total-spent').textContent = `Rs ${totalSpent.toLocaleString('en-IN')}`;
        document.getElementById('total-remaining').textContent = `Rs ${totalRemaining.toLocaleString('en-IN')}`;
    }

    function renderBudgets() {
        const container = document.getElementById('budgets-list');
        if (!container) return;
        
        container.innerHTML = '';
        const assignedCount = budgetsData.filter(b => b.isCardAssigned).length;
        const canAssignMore = assignedCount < MAX_CARD_ASSIGNMENTS;
        const baseButtonClasses = "card-assign-btn text-xs py-1 px-2 rounded";

        budgetsData.forEach((budget, index) => {
            const percentage = budget.limit > 0 ? Math.round((budget.spent / budget.limit) * 100) : 0;
            const progressBarColor = percentage > 90 ? 'bg-red-500' : 'progress-bar-fill';
            const borderClass = index > 0 ? 'border-t pt-6 mt-6' : '';
            
            let cardAssignmentButton;
            if (budget.isCardAssigned) {
                cardAssignmentButton = `<button class="${baseButtonClasses} btn-secondary" data-id="${budget.id}" data-action="unassign">Unassign</button>`;
            } else if (canAssignMore) {
                cardAssignmentButton = `<button class="${baseButtonClasses} btn-primary" data-id="${budget.id}" data-action="assign">Assign to Card</button>`;
            } else {
                cardAssignmentButton = `<button class="${baseButtonClasses} btn-disabled" disabled>Slots Full</button>`;
            }

            container.insertAdjacentHTML('beforeend', `
                <div class="budget-item-full ${borderClass}" style="border-color: var(--color-border);">
                    <div class="flex items-start justify-between mb-2">
                         <div class="flex items-center space-x-4">
                            <div class="p-3 bg-${budget.color}-500/20 rounded-lg"><i data-lucide="${budget.icon}" class="w-6 h-6 text-${budget.color}-400"></i></div>
                            <div>
                                <h4 class="font-semibold text-lg flex items-center">${budget.name} ${budget.isCardAssigned ? '<i data-lucide="credit-card" class="w-4 h-4 text-green-400 ml-2"></i>' : ''}</h4>
                                <p class="text-sm text-slate-400">Spent <span class="font-mono">Rs ${budget.spent.toLocaleString('en-IN')}</span> of <span class="font-mono">Rs ${budget.limit.toLocaleString('en-IN')}</span></p>
                            </div>
                        </div>
                        <div class="text-right">
                             <p class="font-medium text-lg ${percentage > 90 ? 'text-red-400' : ''}">${percentage}% Used</p>
                             <div class="flex gap-2 mt-2">
                                ${cardAssignmentButton}
                                <button class="update-budget-btn text-xs btn-secondary py-1 px-2 rounded" data-id="${budget.id}">Update</button>
                                <button class="delete-item-btn text-xs btn-danger py-1 px-2 rounded" data-id="${budget.id}" data-type="budget">Delete</button>
                             </div>
                        </div>
                    </div>
                    <div class="w-full progress-bar-bg rounded-full h-3">
                        <div class="${progressBarColor} h-3 rounded-full" style="width: ${percentage}%"></div>
                    </div>
                </div>
            `);
        });

        const newBudgetBtn = document.getElementById('new-budget-btn');
        const budgetCountText = document.getElementById('budget-count-text');
        if (!newBudgetBtn || !budgetCountText) return;

        if (budgetsData.length >= MAX_BUDGETS) {
            newBudgetBtn.classList.add('btn-disabled');
            newBudgetBtn.disabled = true;
            budgetCountText.textContent = `You have reached the maximum of ${MAX_BUDGETS} budgets.`;
        } else {
            newBudgetBtn.classList.remove('btn-disabled');
            newBudgetBtn.disabled = false;
            budgetCountText.textContent = `${budgetsData.length} of ${MAX_BUDGETS} budgets created.`;
        }

        renderBudgetTotals();
    }

    function renderVaults() {
        const savingsContainer = document.getElementById('savings-account-container');
        const goalsContainer = document.getElementById('vaults-list');
        if (!savingsContainer || !goalsContainer) return;
        
        savingsContainer.innerHTML = '';
        goalsContainer.innerHTML = '';
        
        const savingsAccount = vaultsData.find(v => v.isSavingsAccount);
        const goalVaults = vaultsData.filter(v => !v.isSavingsAccount);

        if (savingsAccount) {
            savingsContainer.insertAdjacentHTML('beforeend', `
                <div class="bg-slate-900/50 p-6 rounded-2xl flex flex-col md:flex-row md:items-center justify-between border-2 border-green-500/50">
                    <div class="flex items-center space-x-4 mb-4 md:mb-0">
                        <div class="p-3 bg-green-500/20 rounded-lg"><i data-lucide="${savingsAccount.icon}" class="w-8 h-8 text-green-400"></i></div>
                        <div>
                            <h4 class="font-semibold text-lg">${savingsAccount.name}</h4>
                            <p class="text-sm text-slate-400">Saved: Rs ${Math.floor(savingsAccount.current).toLocaleString('en-IN')}</p>
                        </div>
                    </div>
                    <div class="text-center md:text-right mb-4 md:mb-0 md:mx-auto">
                        <p class="text-2xl font-bold font-mono">Rs ${Math.floor(savingsAccount.current).toLocaleString('en-IN')}</p>
                        <p class="font-medium mt-1 text-green-400">Interest Bearing (${(savingsAccount.returnRate * 100).toFixed(0)}% APR)</p>
                    </div>
                    <div class="flex gap-4 md:flex-col md:w-36">
                        <button class="vault-action-btn flex-1 btn-secondary py-2 rounded-lg" data-id="${savingsAccount.id}" data-type="withdraw">Withdraw</button>
                        <button class="vault-action-btn flex-1 btn-primary py-2 rounded-lg" data-id="${savingsAccount.id}" data-type="deposit">Deposit</button>
                    </div>
                </div>
            `);
        }

        goalVaults.forEach(vault => {
            const percentage = vault.target > 0 ? Math.round((vault.current / vault.target) * 100) : 0;
            goalsContainer.insertAdjacentHTML('beforeend', `
                <div class="bg-slate-900/50 p-6 rounded-2xl flex flex-col">
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex items-center space-x-4">
                            <div class="p-3 bg-${vault.color}-500/20 rounded-lg"><i data-lucide="${vault.icon}" class="w-8 h-8 text-${vault.color}-400"></i></div>
                                <div>
                                <h4 class="font-semibold text-lg">${vault.name}</h4>
                                <p class="text-sm text-slate-400">Target: Rs ${vault.target.toLocaleString('en-IN')}</p>
                            </div>
                        </div>
                        <button class="delete-item-btn text-slate-500 hover:text-red-500" data-id="${vault.id}" data-type="vault"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                    </div>
                    <div class="text-center my-4 flex-1">
                        <p class="text-3xl font-bold font-mono">Rs ${vault.current.toLocaleString('en-IN')}</p>
                        <p class="font-medium mt-1" style="color: var(--color-primary)">${percentage}% Complete</p>
                    </div>
                    <div class="w-full progress-bar-bg rounded-full h-3 mb-4">
                        <div class="progress-bar-fill h-3 rounded-full" style="width: ${percentage}%"></div>
                    </div>
                        <div class="flex gap-4">
                            <button class="vault-action-btn flex-1 btn-secondary py-2 rounded-lg" data-id="${vault.id}" data-type="withdraw">Withdraw</button>
                            <button class="vault-action-btn flex-1 btn-primary py-2 rounded-lg" data-id="${vault.id}" data-type="deposit">Deposit</button>
                        </div>
                </div>
            `);
        });
    }
    
    function renderAllHistory() {
        const savingsHistoryList = document.getElementById('savings-history-list');
        const vaultHistoryList = document.getElementById('vault-history-list');
        const budgetHistoryList = document.getElementById('budget-history-list');
        if (!savingsHistoryList || !vaultHistoryList || !budgetHistoryList) return;
        
        savingsHistoryList.innerHTML = '';
        savingsAccountHistoryData.forEach(item => {
            const amountClass = item.amount > 0 ? 'text-green-400' : 'text-red-400';
            const sign = item.amount > 0 ? '+' : '-';
            savingsHistoryList.insertAdjacentHTML('beforeend', `
                <tr class="border-b last:border-b-0" style="border-color: var(--color-border);">
                    <td class="p-3 text-slate-400">${item.date}</td>
                    <td class="p-3 font-medium">${item.action}</td>
                    <td class="p-3">${item.details}</td>
                    <td class="p-3 text-right font-mono ${amountClass}">${sign}Rs ${Math.abs(item.amount).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                </tr>
            `);
        });

        vaultHistoryList.innerHTML = '';
        vaultHistoryData.forEach(item => {
            vaultHistoryList.insertAdjacentHTML('beforeend', `
                <tr class="border-b last:border-b-0" style="border-color: var(--color-border);">
                    <td class="p-3 text-slate-400">${item.date}</td>
                    <td class="p-3 font-medium">${item.action}</td>
                    <td class="p-3">${item.details}</td>
                </tr>
            `);
        });
        
        budgetHistoryList.innerHTML = '';
        budgetHistoryData.forEach(item => {
            budgetHistoryList.insertAdjacentHTML('beforeend', `
                 <tr class="border-b last:border-b-0" style="border-color: var(--color-border);">
                    <td class="p-3 text-slate-400">${item.date}</td>
                    <td class="p-3 font-medium">${item.action}</td>
                    <td class="p-3">${item.details}</td>
                </tr>
            `);
        });
    }

    function displayAIAdvice() {
        const advice = getSmartAIAdvice();
        if (!aiAdviceContent) return;

        aiAdviceContent.innerHTML = `<p class="text-sm">${advice.text}</p>`;
        if (advice.action === 'move') {
            aiActionButton.textContent = `Move Savings`;
            aiActionButton.classList.remove('hidden');
        } else {
            aiActionButton.classList.add('hidden');
        }
    }

    function renderNotifications() {
        if (!notificationList) return;
        notificationList.innerHTML = '';
        notificationsData.forEach(notif => {
            notificationList.insertAdjacentHTML('beforeend', `
                <div class="p-3 border-b border-slate-600 hover:bg-slate-600/50 flex items-start space-x-3">
                    <div class="p-1.5 bg-blue-500/20 rounded-full mt-1">
                        <i data-lucide="${notif.icon}" class="w-4 h-4 text-blue-400"></i>
                    </div>
                    <div>
                        <p class="text-sm">${notif.text}</p>
                        <p class="text-xs text-slate-400">${notif.time}</p>
                    </div>
                </div>
            `);
        });
    }


    // --- EVENT LISTENERS ---
    function setupEventListeners() {
        document.body.addEventListener('click', (e) => {
            // Navigation
            const navLink = e.target.closest('.nav-link');
            if (navLink) {
                e.preventDefault();
                showPage(navLink.dataset.target);
            }

            // Quick Actions
            if (e.target.closest('#add-money-btn')) addMoneyModal.classList.remove('hidden');
            if (e.target.closest('#send-money-btn')) sendMoneyModal.classList.remove('hidden');
            if (e.target.closest('#qr-pay-btn')) qrScannerModal.classList.remove('hidden');

            
            // AI Advisor
            if(e.target.closest('#new-advice-btn')) {
                displayAIAdvice(); // Will get a new smart advice
            }
            if(e.target.closest('#ai-action-btn')) {
                const advice = getSmartAIAdvice(); // Re-evaluate to be sure
                if (advice.action === 'move' && advice.amount && advice.targetVault) {
                    const success = handleVaultTransaction(advice.targetVault, 'deposit', advice.amount);
                    if (success) {
                        showToast(`Successfully moved Rs ${advice.amount.toLocaleString('en-IN')} to ${advice.targetVault} vault.`);
                        updateUI();
                    }
                }
            }

            // New Item Buttons
            if (e.target.closest('#new-vault-btn')) {
                newVaultModal.classList.remove('hidden');
                document.getElementById('vault-name').focus();
            }
            if (e.target.closest('#new-budget-btn')) {
                newBudgetModal.classList.remove('hidden');
                document.getElementById('budget-name').focus();
            }

            // Modal Close Buttons
            const modal = e.target.closest('.fixed.inset-0');
            if (e.target.dataset.action === 'close' || e.target === modal) {
                modal.classList.add('hidden');
            }

            // Update Budget Button
            const updateBtn = e.target.closest('.update-budget-btn');
            if(updateBtn) {
                const budgetId = updateBtn.dataset.id;
                const budget = budgetsData.find(b => b.id === budgetId);
                if(budget) {
                    document.getElementById('update-budget-id').value = budget.id;
                    document.getElementById('update-budget-name').value = budget.name;
                    document.getElementById('update-budget-limit').value = budget.limit;
                    updateBudgetModal.classList.remove('hidden');
                }
            }

            // Vault Action Button (Deposit/Withdraw)
            const vaultActionBtn = e.target.closest('.vault-action-btn');
            if(vaultActionBtn) {
                const vaultId = vaultActionBtn.dataset.id;
                const actionType = vaultActionBtn.dataset.type;
                const vault = vaultsData.find(v => v.id === vaultId);
                if(vault) {
                    document.getElementById('vault-action-title').textContent = `${actionType.charAt(0).toUpperCase() + actionType.slice(1)} to ${vault.name}`;
                    document.getElementById('vault-action-id').value = vault.id;
                    document.getElementById('vault-action-type').value = actionType;
                    document.getElementById('vault-action-submit').textContent = `Confirm ${actionType.charAt(0).toUpperCase() + actionType.slice(1)}`;
                    vaultActionModal.classList.remove('hidden');
                    document.getElementById('vault-action-amount').focus();
                }
            }

            // Delete Item Button
            const deleteBtn = e.target.closest('.delete-item-btn');
            if (deleteBtn) {
                itemToDelete = { id: deleteBtn.dataset.id, type: deleteBtn.dataset.type };
                const item = itemToDelete.type === 'budget' 
                    ? budgetsData.find(b => b.id === itemToDelete.id)
                    : vaultsData.find(v => v.id === itemToDelete.id);
                
                if (item.isSavingsAccount) {
                    alert("The main Savings Account cannot be deleted.");
                    return;
                }

                document.getElementById('confirm-delete-title').textContent = `Delete ${item.name}?`;
                let message = `This will permanently delete the ${itemToDelete.type}.`;
                if (itemToDelete.type === 'vault' && item.current > 0) {
                    message += ` The remaining balance of Rs ${item.current.toLocaleString('en-IN')} will be returned to your Current Account.`
                }
                document.getElementById('confirm-delete-message').textContent = message;
                confirmDeleteModal.classList.remove('hidden');
            }

            // Card Assignment Button
            const assignBtn = e.target.closest('.card-assign-btn');
            if (assignBtn) {
                const budgetId = assignBtn.dataset.id;
                const action = assignBtn.dataset.action;
                const budget = budgetsData.find(b => b.id === budgetId);
                if (budget) {
                    budget.isCardAssigned = (action === 'assign');
                    updateUI();
                }
            }

            // Notifications
            if (e.target.closest('#notifications-btn')) {
                notificationsDropdown.classList.toggle('hidden');
            } else if (!e.target.closest('#notifications-dropdown')) {
                notificationsDropdown.classList.add('hidden');
            }

            // Onboarding
            const onboardingNext = e.target.closest('.onboarding-next');
            if(onboardingNext) {
                const currentStep = onboardingNext.closest('[id^="onboarding-step-"]');
                const nextStepNumber = parseInt(currentStep.id.split('-')[2]) + 1;
                currentStep.classList.add('hidden');
                document.getElementById(`onboarding-step-${nextStepNumber}`).classList.remove('hidden');
            }
            const onboardingPrev = e.target.closest('.onboarding-prev');
            if(onboardingPrev) {
                const currentStep = onboardingPrev.closest('[id^="onboarding-step-"]');
                const prevStepNumber = parseInt(currentStep.id.split('-')[2]) - 1;
                currentStep.classList.add('hidden');
                document.getElementById(`onboarding-step-${prevStepNumber}`).classList.remove('hidden');
            }
            if(e.target.closest('.onboarding-finish')) {
                onboardingModal.classList.add('hidden');
                localStorage.setItem('finvault_onboarding_complete', 'true');
            }
        });

        confirmDeleteBtn.addEventListener('click', () => {
            const { id, type } = itemToDelete;
            if (type === 'budget') {
                deleteBudget(id);
            } else if (type === 'vault') {
                deleteVault(id);
            }
            
            confirmDeleteModal.classList.add('hidden');
            updateUI();
            itemToDelete = { id: null, type: null };
        });

        accountSelector.addEventListener('change', (e) => {
            if(e.target.name === 'activeAccount') {
                activeAccountId = e.target.value;
                updateUI();
            }
        });
        
        freezeToggle.addEventListener('change', () => { isCardFrozen = !isCardFrozen; updateUI(); });
        
        locateCardBtnSettings.addEventListener('click', () => mapModal.classList.remove('hidden'));
        closeMapModalBtn.addEventListener('click', () => mapModal.classList.add('hidden'));
        
        mobileMenuButton.addEventListener('click', () => mobileSidebar.classList.remove('-translate-x-full'));
        closeMobileMenuButton.addEventListener('click', () => mobileSidebar.classList.add('-translate-x-full'));
        
        addMoneyForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const amount = parseFloat(e.target.elements['add-money-amount'].value);
            if (amount > 0) {
                accounts.find(a => a.id === 'current').balance += amount;
                transactionsData.unshift({
                    date: getCurrentDate(), desc: 'Deposit from external source', cat: 'Income', amount: amount
                });
                showToast(`Rs ${amount.toLocaleString('en-IN')} added successfully.`);
                updateUI();
                addMoneyModal.classList.add('hidden');
                e.target.reset();
            }
        });
        
        sendMoneyForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const amount = parseFloat(e.target.elements['send-money-amount'].value);
            const recipient = e.target.elements['send-money-recipient'].value;
            const currentAccount = accounts.find(a => a.id === 'current');
            
            if (amount > 0 && recipient && currentAccount.balance >= amount) {
                currentAccount.balance -= amount;
                transactionsData.unshift({
                    date: getCurrentDate(), desc: `Sent to ${recipient}`, cat: 'Transfer', amount: -amount
                });
                showToast(`Rs ${amount.toLocaleString('en-IN')} sent successfully.`);
                updateUI();
                sendMoneyModal.classList.add('hidden');
                e.target.reset();
            } else if (currentAccount.balance < amount) {
                showToast('Insufficient funds.');
            }
        });

        newVaultForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = e.target.elements['vault-name'].value;
            const target = parseFloat(e.target.elements['vault-target'].value);
            if (createVault(name, target)) {
                updateUI();
                newVaultModal.classList.add('hidden');
                e.target.reset();
            }
        });

        newBudgetForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = e.target.elements['budget-name'].value;
            const limit = parseFloat(e.target.elements['budget-limit'].value);
            if (createBudget(name, limit)) {
                updateUI();
                newBudgetModal.classList.add('hidden');
                e.target.reset();
            }
        });

        updateBudgetForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const budgetId = e.target.elements['update-budget-id'].value;
            const newName = e.target.elements['update-budget-name'].value;
            const newLimit = parseFloat(e.target.elements['update-budget-limit'].value);
            
            if(updateBudget(budgetId, newName, newLimit)) {
                updateUI();
                updateBudgetModal.classList.add('hidden');
                e.target.reset();
            }
        });

        vaultActionForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const vaultId = e.target.elements['vault-action-id'].value;
            const actionType = e.target.elements['vault-action-type'].value;
            const amount = parseFloat(e.target.elements['vault-action-amount'].value);

            if (handleVaultTransaction(vaultId, actionType, amount)) {
                updateUI();
                vaultActionModal.classList.add('hidden');
                e.target.reset();
            }
        });
        
        showSavingsHistoryBtn.addEventListener('click', () => {
            savingsHistoryContainer.classList.toggle('hidden');
            vaultHistoryContainer.classList.add('hidden');
            budgetHistoryContainer.classList.add('hidden');
        });

        showVaultHistoryBtn.addEventListener('click', () => {
            vaultHistoryContainer.classList.toggle('hidden');
            savingsHistoryContainer.classList.add('hidden');
            budgetHistoryContainer.classList.add('hidden');
        });

        showBudgetHistoryBtn.addEventListener('click', () => {
            budgetHistoryContainer.classList.toggle('hidden');
            vaultHistoryContainer.classList.add('hidden');
            savingsHistoryContainer.classList.add('hidden');
        });
        
        simulatePayoutBtn.addEventListener('click', () => {
            calculateAndApplyMonthlyReturns();
            updateUI();
        });
        
        exportSpendingBtn.addEventListener('click', () => exportToCsv('spending_history.csv', ['date', 'desc', 'cat', 'amount'], transactionsData));
        exportSavingsHistoryBtn.addEventListener('click', () => exportToCsv('savings_account_history.csv', ['date', 'action', 'details', 'amount'], savingsAccountHistoryData));
        exportVaultHistoryBtn.addEventListener('click', () => exportToCsv('vault_history.csv', ['date', 'action', 'details'], vaultHistoryData));
        exportBudgetHistoryBtn.addEventListener('click', () => exportToCsv('budget_history.csv', ['date', 'action', 'details'], budgetHistoryData));
        
        themeSelector.addEventListener('click', (e) => {
            const themeBtn = e.target.closest('.theme-btn');
            if (themeBtn) {
                const themeName = themeBtn.dataset.theme;
                applyTheme(themeName);
                saveTheme(themeName);
                document.querySelectorAll('.theme-btn').forEach(btn => {
                    btn.classList.toggle('border-white', btn.dataset.theme === themeName);
                    btn.classList.toggle('border-transparent', btn.dataset.theme !== themeName);
                });
            }
        });
    }


    // --- INITIALIZATION ---
    function init() {
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
        generateThemeSelector();
        setupEventListeners();
        updateUI();
        showPage('dashboard');

        if (localStorage.getItem('finvault_onboarding_complete') !== 'true') {
            onboardingModal.classList.remove('hidden');
        }
    }

    document.addEventListener('DOMContentLoaded', init);

})(); // IIFE End
</script>
</body>
</html>

